---

- name: "Flush handlers to see if reboot is required"
  meta: flush_handlers

- name: "Check /var/run/reboot-required"
  stat:
    path: /var/run/reboot-required
  register: common_reboot_required_file
  changed_when: common_reboot_required_file.stat.exists

- block:
    - name: "Reboot machine"
      shell: nohup bash -c "sleep 2s && shutdown -r now" &
      become: yes

    - name: "Wait for the ssh connection to return"
      wait_for_connection:
        timeout: 240
        delay: 15

    - name: "Reset the reboot flag"
      set_fact:
        common_reboot_required: no
  when: common_reboot_required or common_reboot_required_file.stat.exists
